<script>
  function editarUsuarioModal(rowData) {
    const columnNameExp = rowData[columToTable[3].field];
    const additionalData = dataRegular.additionalData.filter(item => item.expediente === columnNameExp);
    const actividadesArray = dataRegular.additionalData.map(item => [item.actividad]);
    
    const form = document.getElementById('crearUsuario');

    const cajaEstado = form.estadoEmpresa;
    populateUniqueOptions(cajaEstado, dataRegular.data, 6);
    const cajaActividad = form.actividad;
    populateUniqueOptions(cajaActividad, actividadesArray, 0);

    const data = additionalData[0]; // Extraemos los datos de la empresa

    console.log("datosEmpresaClick")
    console.log(data);

    // Llenar nombre empresa
    document.getElementById("nombreEmpresa").textContent = data.empresa;

    // Llenar campos del formulario si existen en el form
    Object.keys(data).forEach(key => {
      if (form[key] !== undefined) {
        form[key].value = data[key];
      }
    });

    // Manejo de campos según tipo de trámite
    const columnNameTram = rowData[columToTable[4].field];
    const estadoEmpresa = data.estadoEmpresa;

    document.getElementById("expobienal-hidden").hidden = columnNameTram !== "Revalidación Bienal";

    const requisitosAdicionales = document.getElementById("requisitosAdicionales");
    requisitosAdicionales.hidden = ["Acreditación de Cumplimiento Anual", "Ratificación de Adhesión"].includes(columnNameTram);

    const hiddenNumActo = document.getElementById("hiddenNumActo");
    const actoOprovi = document.getElementById("actoOprovi");
    if (["Inscripción al Régimen", "Solicitud de Baja", "Ratificación de Adhesión"].includes(columnNameTram)) {
      hiddenNumActo.hidden = false;
      actoOprovi.textContent = "Acto Administrativo";
    } else {
      hiddenNumActo.hidden = true;
      actoOprovi.textContent = "Providencia";
    }

    const showActoFields = ["Inscripción al Régimen", "Ratificación de Adhesión", "Solicitud de Baja"].includes(columnNameTram);
    document.getElementById("hiddenFechaInscripcion").hidden = !showActoFields;
    document.getElementById("hiddenActo").hidden = !showActoFields;
    document.getElementById("hidden-1266").hidden = !showActoFields;

    const labelFechaInscripcion = document.getElementById("labelFechaInscripcion");
    labelFechaInscripcion.textContent = columnNameTram === "Solicitud de Baja" ? "Fecha Baja Otorgada" : "Fecha Inscripción";

    const subsanacion = document.getElementById("subsaHidden");
    subsanacion.classList.toggle("hidden", estadoEmpresa !== "Subsanación");

    // Usar la función centralizada para llenar campos especiales
    cargarCamposEmpresa(data);
  }

  function cargarCamposEmpresa(data) {
    // Divs de texto directo (algunos con paréntesis)
    const camposConParentesis = ['revisorRealLegal', 'revisorRealFinal'];
    const camposDirectos = ['asesorLegal', 'revisorFinal', 'fechaRevisionLegal', 'flex-dato-afip', 'flex-dato-emision', ...camposConParentesis];

    camposDirectos.forEach(id => {
      const el = document.getElementById(id);
      
      if (el) {
        const valor = data[id] || '';
        el.textContent = camposConParentesis.includes(id) && valor ? `(${valor})` : valor;
      }
    });

    // Checkboxes
    const checkboxMap = {
      'flexRevisionLegal': !!data.fechaRevisionLegal,
      'flexRevisionFinal': !!data.fechaRevisionFinal,
      'flex-afip': data.informadoAfip === 'TRUE',
      'flex-emision': data.disponibleEmision === 'TRUE'
    };

    Object.entries(checkboxMap).forEach(([id, checked]) => {
      const el = document.getElementById(id);
      if (el) el.checked = checked;
    });

    // Carpeta de acceso
    const link = document.getElementById("carpetaEmpresaAcceso");
    if (link) link.href = data.carpetaEmpresa || '#';
  }


  // Cambio estado empresa => mostrar campos subsanación
  document.getElementById("estadoEmpresa").addEventListener("change", (event) => {
    const subsanacion = document.getElementById("subsaHidden");
    const elementos = subsanacion.querySelectorAll("date, number");
    const estado = event.target.value;

    const mostrar = estado === 'Subsanación';
    subsanacion.classList.toggle("hidden", !mostrar);
    elementos.forEach(element => element.required = mostrar);
  });

  // Función reutilizable para checkboxes con timestamps
  function updateTimestamp(checkbox, fecharevinow, nameReviReal) {
    const timestamp = new Date().toLocaleString();

    if (checkbox.checked) {
      fecharevinow.textContent = timestamp;
      if (nameReviReal) {
        nameReviReal.textContent = `(${dataUser?.name})` || "(Desconocido)";
      }
    } else {
      fecharevinow.textContent = '';
      if (nameReviReal) {
        nameReviReal.textContent = '';
      }
    }
  }



</script>
