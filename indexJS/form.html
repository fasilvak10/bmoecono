<script>
  function editarUsuarioModal(rowData) {
    console.log(selectedTable);
    let elementosCierre = document.getElementsByClassName("tramite-cierre");
    let elementosRegulares = document.getElementsByClassName("tramite-regular");

    [...elementosCierre].forEach(element => {
      element.hidden = (selectedTable === 'regulares-outlined');
    }); 

    [...elementosRegulares].forEach(element => {
      element.hidden = (selectedTable !== 'regulares-outlined');
    }); 


    const columnNameExp = rowData[columToTable[3].field];
    let dataForm = selectedTable === "regulares-outlined" ? dataRegular.additionalData : dataSetCierres.additionalData;

    const additionalData = dataForm.filter(item => item.expediente === columnNameExp);
    const actividadesArray = dataForm.map(item => [item.actividad]);
    const analistaArray = dataForm.map(item => [item.analista]);
    const estadoArray = dataForm.map(item => [item.estadoEmpresa]);
    const observacionAuditoriaArray = dataForm.map(item => [item.observacionAuditoria]);
    const cuerpoAuditorArray = dataForm.map(item => [item.cuerpoAuditor]);
    //const actividadesArray = dataRegular.additionalData.map(item => [item.actividad]);
    
    const form = document.getElementById('crearUsuario');
    form.reset();

    const cajaEstado = form.estadoEmpresa;
    populateUniqueOptions(cajaEstado, estadoArray, 0);
    const cajaActividad = form.actividad;
    populateUniqueOptions(cajaActividad, actividadesArray, 0);
    const cajaAnalista = form.analista;
    populateUniqueOptions(cajaAnalista, analistaArray, 0);
    const cajaObservacion = form.observacionAuditoria;
    populateUniqueOptions(cajaObservacion, observacionAuditoriaArray, 0);
    const cajaCuerpoAuditor = form.cuerpoAuditor;
    populateUniqueOptions(cajaCuerpoAuditor, cuerpoAuditorArray, 0);

    const data = additionalData[0]; // Extraemos los datos de la empresa

    console.log("datosEmpresaClick")
    console.log(data);

    const tramite = document.getElementById('tramite');
    tramite.innerHTML = data.tramite

    // Llenar nombre empresa
    document.getElementById("nombreEmpresa").textContent = data.empresa;

    // Llenar campos del formulario si existen en el form
    Object.keys(data).forEach(key => {
      if (form[key] !== undefined) {
        form[key].value = data[key];
      }
    });

    // Manejo de campos según tipo de trámite
    const columnNameTram = rowData[columToTable[4].field];
    const estadoEmpresa = data.estadoEmpresa;

    document.getElementById("expobienal-hidden").hidden = columnNameTram !== "Revalidación Bienal";

    const requisitosAdicionales = document.getElementById("requisitosAdicionales");
    requisitosAdicionales.hidden = ["Acreditación de Cumplimiento Anual", "Ratificación de Adhesión"].includes(columnNameTram);

    const hiddenNumActo = document.getElementById("hiddenNumActo");
    const actoOprovi = document.getElementById("actoOprovi");
    if (["Inscripción al Régimen", "Solicitud de Baja", "Ratificación de Adhesión"].includes(columnNameTram)) {
      hiddenNumActo.hidden = false;
      actoOprovi.textContent = "Acto Administrativo";
    } else {
      hiddenNumActo.hidden = true;
      actoOprovi.textContent = "Providencia";
    }

    const showActoFields = ["Inscripción al Régimen", "Ratificación de Adhesión", "Solicitud de Baja"].includes(columnNameTram);
    document.getElementById("hiddenFechaInscripcion").hidden = !showActoFields;
    document.getElementById("hiddenActo").hidden = !showActoFields;
    document.getElementById("hidden-1266").hidden = !showActoFields;

    const labelFechaInscripcion = document.getElementById("labelFechaInscripcion");
    labelFechaInscripcion.textContent = columnNameTram === "Solicitud de Baja" ? "Fecha Baja Otorgada" : "Fecha Inscripción";

    const subsanacion = document.getElementById("subsaHidden");
    subsanacion.classList.toggle("hidden", estadoEmpresa !== "Subsanación");

    // Usar la función centralizada para llenar campos especiales
    mostrarModelos(tramite.innerHTML, data.carpetaEmpresa)
    cargarCamposEmpresa(data);
  }

  function cargarCamposEmpresa(data) {
    // Divs de texto directo (algunos con paréntesis)
    const camposConParentesis = ['revisorRealLegal', 'revisorRealFinal'];
    const camposDirectos = ['asesorLegal', 'revisorFinal', 'fechaRevisionLegal', 'fechaRevisionFinal', 'flex-dato-afip', 'flex-dato-emision', ...camposConParentesis];

    camposDirectos.forEach(id => {
      const el = document.getElementById(id);
      
      if (el) {
        const valor = data[id] || '';
        el.textContent = camposConParentesis.includes(id) && valor ? `(${valor})` : valor;
      }
    });

    // Checkboxes
    const checkboxMap = {
      'flexRevisionLegal': !!data.fechaRevisionLegal,
      'flexRevisionFinal': !!data.fechaRevisionFinal,
      'flex-afip': data.informadoAfip === 'TRUE',
      'flex-emision': data.disponibleEmision === 'TRUE'
    };

    Object.entries(checkboxMap).forEach(([id, checked]) => {
      const el = document.getElementById(id);
      if (el) el.checked = checked;
    });

    // Carpeta de acceso
    const link = document.getElementById("carpetaEmpresa");
    console.log('este es el link ' +data.carpetaEmpresa)
    obtenerArchivos(data.carpetaEmpresa)
    if (link) link.href = data.carpetaEmpresa || '#';

    
  }



  // Cambio estado empresa => mostrar campos subsanación
  document.getElementById("estadoEmpresa").addEventListener("change", (event) => {
    const subsanacion = document.getElementById("subsaHidden");
    const elementos = subsanacion.querySelectorAll("date, number");
    const estado = event.target.value;

    const mostrar = estado === 'Subsanación';
    subsanacion.classList.toggle("hidden", !mostrar);
    elementos.forEach(element => element.required = mostrar);
  });

  // Función reutilizable para checkboxes con timestamps
  function updateTimestamp(checkbox, fecharevinow, nameReviReal) {
    const timestamp = new Date().toLocaleString();

    if (checkbox.checked) {
      fecharevinow.textContent = timestamp;
      if (nameReviReal) {
        nameReviReal.textContent = `(${dataUser?.name})` || "(Desconocido)";
      }
    } else {
      fecharevinow.textContent = '';
      if (nameReviReal) {
        nameReviReal.textContent = '';
      }
    }
  }



</script>