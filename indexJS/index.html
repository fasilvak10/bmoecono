<!-- Funci√≥n ECONOCIMIENTO Header -->
<script>
  function iniciarTypedUnaVez() {
    const words = ['software', 'servicios', 'audiovisual', 'biotecnolog√≠a', 'nanotecnolog√≠a', 'aeroespacial', 'satelital', 'industria', 'ingenier√≠as', 'creaci√≥n de empleo', 'exportaciones', 'talento'];
    let typed = null;

    // Funci√≥n para crear el efecto Typed con una palabra
    function escribirPalabra(palabra) {
      if (typed) {
        typed.destroy(); // elimina la instancia anterior
      }

      typed = new Typed('#typing', {
        strings: [palabra],
        typeSpeed: 50,
        showCursor: false,
        loop: false,
      });
    }

    // Elegir y escribir la primera palabra
    const palabraInicial = words[Math.floor(Math.random() * words.length)];
    escribirPalabra(palabraInicial);

    // Al hacer click se elige otra palabra distinta y se vuelve a escribir con efecto
    document.getElementById('typing').addEventListener('click', function () {
      let nuevaPalabra;
      do {
        nuevaPalabra = words[Math.floor(Math.random() * words.length)];
      } while (nuevaPalabra === typed.strings[0]); // evitar repetir la misma palabra

      escribirPalabra(nuevaPalabra);
    });
  }

  function reglasOnboarding() {
    const reglas = `1. Prep√°rate para trabajar con un sistema accesible y divertido.
    2. Eleg√≠ tu acompa√±ante para ayudarte en tus tareas.
    3. Eleg√≠ con cautela, porque te va a guiar por un buen tiempo‚Ä¶ <strong>jsjsjs</strong>.`;

    new Typed('#typingOB', {
      strings: [reglas],
      typeSpeed: 35,
      showCursor: false,
      loop: false,
      smartBackspace: true
    });
  }

  function animarCards() {
    const cardCols = document.querySelectorAll('.col.d-flex'); // o m√°s espec√≠fico si quer√©s
    cardCols.forEach((col) => {
      col.classList.add('card-animated');
    });
  }



  document.addEventListener('DOMContentLoaded', function () {
    const navbar = document.querySelector('.navbar');
    const observer = new IntersectionObserver(
      ([entry]) => {
        if (!entry.isIntersecting) {
          navbar.classList.add('navbar-blur');
        } else {
          navbar.classList.remove('navbar-blur');
        }
      },
      { threshold: 0 }
    );

    observer.observe(document.body);
    
    
  });

  function abrirEnlace(element) {
    var enlace = element.getAttribute('href');
    
    //window.open(enlace, '_blank');
    //obtenerArchivos(enlace)

  }

  function obtenerArchivos(urlCarpeta) {
    const dropdown = document.getElementById("dropdownArchivos");
    urlCarpeta !== '' ?  dropdown.innerHTML = " Cargando..." :  dropdown.innerHTML = ' La Empresa no cuenta con archivos';
    google.script.run
      .withSuccessHandler(function(archivos) {
        dropdown.classList.add('blur')
        dropdown.innerHTML = ""; // Limpiar previo

        archivos.forEach(archivo => {
          const nombreCorto = truncarNombre(archivo.nombre);
          const ext = detectarTipo(archivo.tipo);
          const esInforme = archivo.nombre.toLowerCase().includes("informe");

          const item = document.createElement("li");
          const link = document.createElement("a");
          
          link.className = "dropdown-item";
          
          if (esInforme) {
            link.classList.add("text-primary", "fw-bold"); // üí° resaltado
          }

          if (archivo.tipo.includes("spreadsheet")) {
            link.classList.add("text-success"); // üíö Verde para archivos tipo Sheet
          }

          link.href = archivo.url;
          link.target = "_blank";
          link.textContent = `${nombreCorto} ${ext}`;
          link.setAttribute("data-bs-toggle", "tooltip");
          link.setAttribute("data-bs-placement", "right");
          link.setAttribute("title", archivo.nombre); // Tooltip visible al apoyar

          item.appendChild(link);
          dropdown.appendChild(item);
        });

        // Inicializar tooltips de Bootstrap
        const tooltipTriggerList = [].slice.call(dropdown.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
          new bootstrap.Tooltip(tooltipTriggerEl);
        });

        dropdown.classList.remove('blur')
      })
      .obtenerArchivosDesdeUrl(urlCarpeta);
  }

  function truncarNombre(nombre) {
    const maxPalabras = 6;
    const palabras = nombre.split(" ");
    if (palabras.length <= maxPalabras) return nombre;
    return palabras.slice(0, maxPalabras).join(" ") + "‚Ä¶";
  }

  function detectarTipo(mime) {
    if (mime.includes("spreadsheet")) return "[.sheet]";
    if (mime.includes("document")) return "[.doc]";
    if (mime.includes("presentation")) return "[.slide]";
    if (mime.includes("pdf")) return "[.pdf]";
    if (mime.includes("folder")) return "[.folder]";
    return "[.file]";
  }

  function mostrarModelos(tramite, carpetaEmpresa) {
    const dropdown = document.getElementById("dropdownModelos");
    dropdown.innerHTML = ""; // Limpiar

    // üëâ Agregar opci√≥n "Carpeta Empresa"
    const liCarpeta = document.createElement("li");
    const aCarpeta = document.createElement("a");
    aCarpeta.className = "dropdown-item text-primary fw-bold"; // le damos un estilo distintivo
    aCarpeta.href = "#";
    carpetaEmpresa !== '' ? aCarpeta.textContent = "üìÅ Abrir Carpeta de la Empresa" : aCarpeta.textContent = "üìÅ La Empresa no cuenta con Carpeta" ;
    aCarpeta.dataset.tipo = "carpeta-empresa"; // para distinguirlo luego
    aCarpeta.dataset.url = carpetaEmpresa;

    aCarpeta.onclick = function(event) {
      event.preventDefault();
      crearArchivos(this, carpetaEmpresa); // lo vas a manejar por `dataset.tipo`
    };

    liCarpeta.appendChild(aCarpeta);
    dropdown.appendChild(liCarpeta);

    // Agregar modelos filtrados
    listaModelosDisponibles
      .filter(i => i[3] == tramite || i[3] === "")
      .forEach(([nombre]) => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.className = "dropdown-item";
        a.href = "#";
        a.textContent ="üìù "+ nombre;

        a.onclick = function(event) {
          event.preventDefault();
          crearArchivos(this, carpetaEmpresa);
        };

        li.appendChild(a);
        dropdown.appendChild(li);
      });

  }

  // Agregar animaci√≥n al hover
  const iconLink = document.querySelector('.icon-link-hover');
  iconLink.addEventListener('mouseover', () => {
    iconLink.style.transform = 'translateY(-10px)';
  });
  iconLink.addEventListener('mouseout', () => {
    iconLink.style.transform = 'translateY(0)';
  });
  

  var chatHistoryToggle = [];

  function toggleInfo(event) {
    if (event) {
      event.preventDefault();
    }

    let resultados = "";
    if (rowToTable) {
      resultados = Object.values(rowToTable).filter(
        fila =>
          fila["Analista Asignado (evaluador)"] === dataUser.name &&
          fila["Sub Estado"]?.toLowerCase() === "abierta"
      );
    }

    const spinner = document.getElementById('spinnerMainCharacter');
    spinner.hidden = false;
    const infoBubble = document.getElementById('infoBubble');
    if (!infoBubble.hidden) infoBubble.hidden = true;
    const geminiRest = document.getElementById('geminiRest');

    google.script.run.withSuccessHandler((respuesta) => {
      spinner.hidden = true;
      infoBubble.hidden = false;
      geminiRest.innerHTML = '';

      const mensajeFormateado = formatearRespuestaIA(respuesta);

      // üíæ Guardar en el historial
      chatHistoryToggle.push({
        timestamp: new Date().toISOString(),
        usuario: dataUser.name,
        consulta: resultados,  // Pod√©s tambi√©n reducir los datos si quer√©s
        respuesta: mensajeFormateado
      });

      //console.log(chatHistoryToggle)

      new Typed('#geminiRest', {
        strings: [mensajeFormateado],
        typeSpeed: 20,
        backSpeed: 25,
        showCursor: false,
        loop: false,
        onComplete: () => {
          // Pod√©s hacer algo al final del tipeo si quer√©s
        }
      });

    }).geminiAPI(resultados, dataUser, chatHistoryToggle);
  }


  function launchConfetti() {
    const duration = 3 * 1000;
    const end = Date.now() + duration;

    // Crear canvas que cubre toda la pantalla
    const myCanvas = document.createElement('canvas');
    myCanvas.style.position = 'fixed';
    myCanvas.style.top = 0;
    myCanvas.style.left = 0;
    myCanvas.style.width = '100%';
    myCanvas.style.height = '100%';
    myCanvas.style.pointerEvents = 'none';
    myCanvas.style.zIndex = 9999;

    document.body.appendChild(myCanvas);

    const myConfetti = confetti.create(myCanvas, {
      resize: true,
      useWorker: true
    });

    (function frame() {
      myConfetti({
        particleCount: 6,
        angle: 90,
        spread: 360,
        startVelocity: 5,
        gravity: 0.6,
        ticks: 400,
        origin: {
          x: Math.random(), // aleatorio en todo el ancho
          y: 0
        }
      });

      if (Date.now() < end) {
        requestAnimationFrame(frame);
      } else {
        setTimeout(() => {
          document.body.removeChild(myCanvas);
        }, 6000); // deja que termine de desvanecerse
      }
    })();
  }



  // Funci√≥n para animar el contador
  function animateCounter(element, start, end, duration) {
      let startTime = null;

      function step(currentTime) {
          if (!startTime) startTime = currentTime;
          const progress = Math.min((currentTime - startTime) / duration, 1);
          element.innerText = Math.floor(progress * (end - start) + start);
          if (progress < 1) {
              requestAnimationFrame(step);
          }
      }

      requestAnimationFrame(step);
  }

  // Funci√≥n para detectar si el elemento est√° en la vista
  function isElementInViewport(el) {
      const rect = el.getBoundingClientRect();
      return rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);
  }

  // Activar el contador cuando el usuario hace scroll
  document.addEventListener('scroll', () => {
      document.querySelectorAll('.counter').forEach((counter) => {
          if (isElementInViewport(counter) && !counter.classList.contains('counted')) {
              counter.classList.add('counted');
              animateCounter(counter, 0, parseInt(counter.dataset.target), 2000); // 2000 ms para la duraci√≥n
          }
      });
  });


  /*FUNTION AJUSTE DE PAGINA*/

  const offcanvas = document.getElementById('offcanvasRight');
  const resizeBar = offcanvas.querySelector('.resize-bar');
  let isDragging = false;

  resizeBar.addEventListener('mousedown', () => {
      isDragging = true;
      document.addEventListener('mousemove', resize);
      document.addEventListener('mouseup', () => {
          isDragging = false;
          document.removeEventListener('mousemove', resize);
      });
  });

  function resize(event) {
      if (isDragging) {
          const newWidth = window.innerWidth - event.clientX;
          if (newWidth >= 200 && newWidth <= window.innerWidth / 2) { // Limitar el redimensionamiento
              offcanvas.style.width = newWidth + 'px';
          }
      }
  }

  /* ASIDE MENU BAR*/

  const aside = document.getElementById('asideMain');
  const openAside = document.getElementById('asideButton');

  openAside.addEventListener('click', () => {
    aside.classList.toggle('active');
  });

  const closeAside = document.getElementById('closeAsideButton');

  closeAside.addEventListener('click', () => {
    aside.classList.toggle('active');
  });

  /* DARKMODE */

  const toggleBtn = document.getElementById("modoOscuroBtn");

  // Verificar en el localStorage al cargar la p√°gina
  if (localStorage.getItem("modoOscuro") === "true") {
    document.body.classList.add("dark-mode");
    toggleBtn.innerHTML = `<i class="bi bi-brightness-high"></i>`;
  }

  toggleBtn.addEventListener("click", function () {
    const modoOscuroActivado = document.body.classList.toggle("dark-mode");

    // Guardar en localStorage
    localStorage.setItem("modoOscuro", modoOscuroActivado);

    // Cambiar √≠cono seg√∫n el estado
    if (modoOscuroActivado) {
      toggleBtn.innerHTML = `<i class="bi bi-brightness-high"></i>`;
    } else {
      toggleBtn.innerHTML = `<i class="bi bi-moon"></i>`;
    }
  });

  /* TEXTAREA AUTOAJUSTE */

  const textarea = document.getElementById('user-input');

  textarea.addEventListener('input', () => {
    textarea.style.height = 'auto'; // Resetea la altura
    textarea.style.height = textarea.scrollHeight + 'px'; // Ajusta al contenido
  });

  // Opcional: ajustar altura inicial
  window.addEventListener('DOMContentLoaded', () => {
    textarea.style.height = 'auto';
    textarea.style.height = textarea.scrollHeight + 'px';
  });

  /* VERSION ACTUALIZADA */

  //let session = "abc123"; // O traelo de localStorage, backend, etc.

  function verificarSesion() {
    GetData(true);
    const aviso = document.getElementById("avisoSession");

    if (typeof session === 'undefined' || !session) {
      console.log("‚ö†Ô∏è session no est√° definido o es falso. No se verifica sesi√≥n.");
      return;
    }

    console.log("‚úÖ Verificando sesi√≥n con session =", session);

    google.script.run
      .withSuccessHandler(function(resultadoServidor) {
        if (resultadoServidor !== session) {
          if (aviso.hidden) {
            alert("Tu sesi√≥n fue cerrada o reemplazada.");
            window.location.href = "https://script.google.com/macros/s/AKfycbwrlNDKabQ08HJqGkfJpmLeOyiY-7pGKlMELAb8TP431Xt4bqxPTiY03pIGJAoMpJBi4Q/exec";
          }
          aviso.hidden = false;
        }
      })
      .withFailureHandler(function(error) {
        console.error("‚ùå Error al verificar la sesi√≥n:", error.message);
      })
      .verificarSesionEnServidor(session);
  }


  // Ejecutar al inicio y luego cada 1 minuto (o cada 15 minutos en prod)
  //verificarSesion();
  setInterval(verificarSesion, 120000); // Cambi√° a 900000 para 15 minutos
  

  // Tambi√©n la pod√©s ejecutar inmediatamente al cargar
  //window.onload = verificarSesion;


</script>