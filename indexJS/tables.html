<script>
    /* GRID */
    
    function tableSelect(e) {
        const selectedButton = e.target;
        const selectedId = selectedButton.id;
        const myGridElement = document.querySelector('#myGrid');
        const change = true;

        // Aplica el desenfoque especÃ­fico y muestra el loader
        myGridElement.classList.add("myGrid-blur");
        showLoadingAnimation();

        myGridElement.classList.add("slide-out");

        setTimeout(() => {
            myGridElement.innerHTML = "";
            if (selectedId === "regulares-outlined") {
                loadTable(dataRegular, change);
            } else if (selectedId === "cierres-outlined") {
                console.log(dataSetCierres.headers[0]);
                console.log(dataSetCierres.headers[1]);
                loadTable(dataSetCierres, change);
            }

            myGridElement.classList.remove("slide-out");
            myGridElement.classList.add("slide-in");

            setTimeout(() => {
                hideLoadingAnimation();
                myGridElement.classList.remove("myGrid-blur");
                myGridElement.classList.remove("slide-in");
            }, 500);
        }, 500);
    }


    function showLoadingAnimation() {
        const loader = document.getElementById("loader");
        loader.style.display = "block";
    }

    function hideLoadingAnimation() {
        const loader = document.getElementById("loader");
        loader.style.display = "none";
    }

 
    function loadTable(dataSet, change) {
        console.log("es un cambio de pensania: "+change)
        // Mapear las columnas
        columToTable = dataSet.headers.map(header => {
            if (['Sub Estado', 'Tareas Pendientes', 'subestado', 'Tarea Pendiente'].includes(header)) {
                return { headerName: header, field: header, hide: true };
            }

            if (header === 'Estado') {
                return {
                    headerName: header,
                    field: header,
                    flex: 1,
                    cellRenderer: function (params) {
                        const tareasPendientes = params.data['Tareas Pendientes'];
                        if (tareasPendientes !== '') {
                            const span = document.createElement("span");
                            span.className = "badge rounded-pill text-bg-warning position-absolute top-0 start-100 translate-middle";
                            span.textContent = "Tarea";
                            span.style = "position: absolute; top: 0; right: 15; font-size: 0.70em";

                            const container = document.createElement("div");
                            container.style.position = "relative";
                            container.textContent = params.value;
                            container.appendChild(span);
                            return container;
                        }
                        return params.value;
                    }
                };
            }

            return { headerName: header, field: header, flex: 1 };
        });

        // Agregar columna de acciones
        columToTable.push({
            headerName: "Acciones",
            field: "acciones",
            cellRenderer: function (params) {
                const rowDataString = JSON.stringify(params.data);
                return `
                    <div style="text-align:center" class="template-acciones text-center">
                        <i class="bi bi-send-fill button-edit me-2" role="button" 
                            onclick='editarUsuarioModal(${rowDataString})' 
                            data-bs-toggle="offcanvas" 
                            data-bs-target="#offcanvasRight" 
                            aria-controls="offcanvasRight" 
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="Editar Empresa"></i>
                        <i class="bi bi-folder-fill button-folder me-2" role="button" style="color: cornflowerblue" onclick="abrirEnlace(this)"></i>
                        <i class="bi bi-gear-fill button-admin me-2" id="buttonAdmin" role="button" onclick="crearOpcionAdmin(this)" hidden></i>
                    </div>
                `;
            },
            width: 150,
            cellStyle: {
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
            }
        });

        // Convertir data en objetos
        rowToTable = dataSet.data.map(row => {
            let rowData = {};
            dataSet.headers.forEach((header, index) => {
                rowData[header] = row[index];
            });
            return rowData;
        });

        if (gridApi && change !== true) {
            // âœ… Solo actualiza los datos si ya existe el grid
            gridApi.setGridOption('rowData', rowToTable);
        } else {
            // ðŸ§± Crea el grid solo una vez
            const gridOptions = {
                defaultColDef: {
                    filter: true,
                    editable: false,
                    width: 150,
                    wrapHeaderText: true,
                    autoHeaderHeight: true,
                    cellClass: 'justify-wrap-text',
                    wrapText: true,
                    headerAlign: 'center',
                    cellStyle: {
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                    },
                    icons: {
                        filter: '<i class="bi bi-funnel"></i>'
                    }
                },
                pagination: true,
                rowData: rowToTable,
                columnDefs: columToTable,
                rowHeight: 50,
                domLayout: 'normal',
                suppressCellSelection: false,
                enableRangeSelection: true,
                enableClipboard: true
            };

            const myGridElement = document.querySelector('#myGrid');
            gridApi = agGrid.createGrid(myGridElement, gridOptions);

            // Filtros personalizados
            ["nombre", "empresa", "cuit", "expediente", "tramite", "fecha", "estado"].forEach((filtro, index) => {
                let element = document.getElementById('filtro-' + filtro);
                if (element) {
                    populateUniqueOptions(element, dataSet.data, index, {
                        includeAll: true,
                        allText: "Todas las opciones"
                    });
                }
            });
        }
    }

</script>