<script>
    var chatHistory = [];
    document.addEventListener('DOMContentLoaded', () => {
        const chatbotContainer = document.getElementById('chatbot-container');
        const chatbotMinimize = document.getElementById('chatbot-minimize');
        const userInput = document.getElementById('user-input');
        const typingIndicator = document.getElementById('typing-indicator');
        const chatbotBody = document.getElementById('chatbot-body');

        chatbotContainer.style.display = 'none';
        chatbotMinimize.style.display = 'block';

        function toggleChatbot() {
            const isHidden = chatbotContainer.style.display === 'none';
            chatbotContainer.style.display = isHidden ? 'block' : 'none';
            chatbotMinimize.style.display = isHidden ? 'none' : 'block';
        }

        function minimizeChatbot() {
            chatbotContainer.style.display = 'none';
            chatbotMinimize.style.display = 'block';
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (message) {
                addMessage('Usuario', message);
                userInput.value = '';

                // Guardar el mensaje del usuario en el historial
                chatHistory.push({ sender: 'Usuario', message });
                console.log("Historial actualizado (usuario):", chatHistory); // Ver historial actualizado

                typingIndicator.classList.remove('d-none');

                google.script.run
                    .withSuccessHandler((response) => {
                        typingIndicator.classList.add('d-none');
                        addMessage('Gemini', response);

                        // Actualizar historial
                        chatHistory.push({ sender: 'Gemini', message: response });
                    })
                    .withFailureHandler((error) => {
                        typingIndicator.classList.add('d-none');
                        addMessage('Error', 'Ocurri√≥ un problema al obtener la respuesta.');
                        console.error(error);
                    })
                    .getRespuestaGemini(message, chatHistory);

            }
        }

        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = 'mb-2';
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatbotBody.appendChild(messageElement);
            chatbotBody.scrollTop = chatbotBody.scrollHeight;
        }

        chatbotMinimize.addEventListener('click', toggleChatbot);
        chatbotContainer.addEventListener('click', (event) => {
            if (event.target.matches('.btn-close')) toggleChatbot();
            if (event.target.matches('.btn-minimize')) minimizeChatbot();
            if (event.target.matches('.btn-send')) sendMessage();
        });
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') sendMessage();
        });
    });




</script>