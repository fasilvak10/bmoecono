<script>
  let modoBusqueda = "tramites"; // por defecto

  document.querySelectorAll('#searchPills .pill').forEach(pill => {
    pill.addEventListener('click', function () {
      // Eliminar la clase active de todas las pills
      document.querySelectorAll('#searchPills .pill').forEach(p => p.classList.remove('active'));

      // Agregar la clase active a la pill seleccionada
      this.classList.add('active');

      // Cambiar el modo de búsqueda
      if (this.textContent.trim() === 'Tramites') {
        modoBusqueda = 'tramites';
      } else if (this.textContent.trim() === 'Empresas') {
        modoBusqueda = 'empresas';
      }
    });
  });

  const inputBusqueda = document.getElementById('buscarRegistro'); // o el ID real de tu input

  inputBusqueda.addEventListener('keydown', function (e) {
    if (e.key === 'Tab') {
      e.preventDefault(); // evitar el tab normal si querés que solo cambie la pill

      const pills = document.querySelectorAll('#searchPills .pill');
      const activePill = document.querySelector('#searchPills .pill.active');

      let nuevaPill;

      if (activePill) {
        // Alternar entre las dos
        nuevaPill = [...pills].find(p => p !== activePill);
      } else {
        // Si no hay ninguna activa, activamos la primera
        nuevaPill = pills[0];
      }

      if (nuevaPill) nuevaPill.click(); // simula el click para reutilizar tu lógica
    }
  });

  document.getElementById("buscarRegistro").addEventListener("input", function () {
    const valorBusqueda = this.value.trim().toLowerCase();

    if (modoBusqueda === 'tramites') {
      if (gridApi) {
        gridApi.setGridOption('quickFilterText', valorBusqueda);
      }
    } else if (modoBusqueda === 'empresas') {
      const data = dataRegular.additionalData;
      const modal = document.getElementById('pseudoModalEmpresas');
      if (modal && modal.style.display !== 'flex') {
        mostrarPseudoModal('pseudoModalEmpresas');
      }
 
      const coincidencias = data.filter(item => {
        const nombre = item.empresa?.toLowerCase() || "";
        const cuit = item.cuit || "";
        const expediente = item.expediente || "";
        return nombre.includes(valorBusqueda) || cuit.includes(valorBusqueda) || expediente.includes(valorBusqueda);
      });

      const filtroRegistro = document.getElementById("filtro-empresa-dateas");
      if (coincidencias.length > 0) {
        // Mostrar empresas coincidentes como opciones del select
        populateUniqueOptions(filtroRegistro, coincidencias, "empresa", {
          sortAlphabetically: false
        });

        llenarFormulario(coincidencias[0].empresa);
      } else {
        // Vaciar el select si no hay coincidencias
        filtroRegistro.innerHTML = '';
      }
    }
  });


  function aplicarFiltrosDesdeSelectores() {
    try {
      const valorBusqueda = document.getElementById("buscarRegistro")?.value.trim().toLowerCase();
      const filterModel = {};
      const filtros = {
        "filtro-nombre": columToTable[0].field,
        "filtro-empresa": columToTable[1].field,
        "filtro-tramite": columToTable[4].field,
        "filtro-estado": columToTable[6].field
      };

      const selectorActivo = document.activeElement?.id || null;
      const esInputBusqueda = (selectorActivo === "buscarRegistro") || (valorBusqueda && valorBusqueda.length > 0);

      // Filtros por select
      Object.entries(filtros).forEach(([filtroId, field]) => {
        const valor = document.getElementById(filtroId)?.value || "";
        if (valor && valor !== "Todas las opciones") {
          filterModel[field] = { type: 'equals', filter: valor };
        }
      });

      // Filtros por checkbox
      if (document.getElementById("filtro-subestado")?.checked) {
        filterModel[columToTable[7].field] = { type: 'contains', filter: 'abierta' };
      }

      if (document.getElementById("filtro-presentacionPendiente")?.checked) {
        filterModel[columToTable[8].field] = { type: 'contains', filter: 'Tiene Actividades Pendientes' };
      }

      if (document.getElementById("filtro-afip")?.checked) {
        filterModel[columToTable[9].field] = { type: 'contains', filter: 'FALSE' };
      }

      // Aplicar filtros
      gridApi.setFilterModel(filterModel);

      if (valorBusqueda) {
        gridApi.setQuickFilter(valorBusqueda);
      }

      const datosFiltrados = obtenerDatosFiltrados();
      console.log("Datos Filtrados:", datosFiltrados);

      if (esInputBusqueda) {
        console.log("Input de búsqueda detectado, actualizando todos los selectores");
        actualizarSelectores(datosFiltrados); // actualiza todos
      } else {
        actualizarSelectores(datosFiltrados, selectorActivo); // excluye el selector activo
      }

    } catch (error) {
      console.error("Error al aplicar filtros:", error);
    }
  }



  function obtenerDatosFiltrados() {
    const datosFiltrados = [];

    gridApi.forEachNodeAfterFilterAndSort(node => {
      datosFiltrados.push(node.data);
    });

    return datosFiltrados;
  }

  const camposMap = {
    "nombre": "Analista Asignado (evaluador)",
    "empresa": "Razón social",
    "cuit": "Cuit",
    "expediente": "Número de expediente",
    "tramite": "Tipo de Trámite",
    "fecha": "Fecha Cambio Estado",
    "estado": "Estado"
  };

  function actualizarSelectores(datosFiltrados, excluirId = null) {
    Object.entries(camposMap).forEach(([filtro, propiedad]) => {
      const selectorId = 'filtro-' + filtro;

      // Omitir el selector si es el activo
      if (excluirId && selectorId === excluirId) return;

      const element = document.getElementById(selectorId);
      if (!element) return;

      const valorSeleccionado = element.value;

      console.log(`Actualizando selector ${selectorId}`);
      
      populateUniqueOptions(element, datosFiltrados, propiedad, {
        includeAll: true,
        allText: "Todas las opciones",
        sortAlphabetically: true
      });

      // Restaurar valor anterior si aún existe
      const existe = Array.from(element.options).some(opt => opt.value === valorSeleccionado);
      element.value = existe ? valorSeleccionado : "Todas las opciones";
    });
  }

  function valoresEnFilters(dataSet) {
    actualizarSelectores(dataSet);
  }


  const input = document.getElementById('buscarRegistro');
  const pills = document.getElementById('searchPills');

  // Mostrar pills al hacer foco
  input.addEventListener('focus', () => {
    pills.classList.remove('d-none');
  });

  // Ocultar pills al hacer clic fuera
  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !pills.contains(e.target)) {
      pills.classList.add('d-none');
    }
  });



</script>